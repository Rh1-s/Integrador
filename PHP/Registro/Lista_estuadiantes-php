<?php
require_once '../config/db.php';

// Filtros
$filtros = [];
$sql = "SELECT * FROM students WHERE 1=1";

if (!empty($_GET['dni'])) {
    $sql .= " AND dni LIKE :dni";
    $filtros[':dni'] = '%' . $_GET['dni'] . '%';
}
if (!empty($_GET['nombre'])) {
    $sql .= " AND nombres_apellidos LIKE :nombre";
    $filtros[':nombre'] = '%' . $_GET['nombre'] . '%';
}
if (!empty($_GET['grado'])) {
    $sql .= " AND grado_seccion LIKE :grado";
    $filtros[':grado'] = '%' . $_GET['grado'] . '%';
}
if (!empty($_GET['situacion'])) {
    $sql .= " AND situacion_matricula LIKE :situacion";
    $filtros[':situacion'] = '%' . $_GET['situacion'] . '%';
}

$stmt = $pdo->prepare($sql);
$stmt->execute($filtros);
$students = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Estudiantes</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <h2>Estudiantes Matriculados</h2>

    <form method="GET">
        <input type="text" name="dni" placeholder="DNI" value="<?= $_GET['dni'] ?? '' ?>">
        <input type="text" name="nombre" placeholder="Nombre" value="<?= $_GET['nombre'] ?? '' ?>">
        <input type="text" name="grado" placeholder="Grado y Sección" value="<?= $_GET['grado'] ?? '' ?>">
        <input type="text" name="situacion" placeholder="Situación" value="<?= $_GET['situacion'] ?? '' ?>">
        <button type="submit">Filtrar</button>
        <a href="student_list.php"><button type="button">Limpiar</button></a>
    </form>

    <table border="1" cellpadding="8" cellspacing="0">
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Fecha Nacimiento</th>
                <th>Sexo</th>
                <th>Grado y Sección</th>
                <th>Situación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach ($students as $stu): ?>
            <tr>
                <td><?= htmlspecialchars($stu['dni']) ?></td>
                <td><?= htmlspecialchars($stu['nombres_apellidos']) ?></td>
                <td><?= htmlspecialchars($stu['fecha_nacimiento']) ?></td>
                <td><?= $stu['sexo'] == 'H' ? 'Hombre' : 'Mujer' ?></td>
                <td><?= htmlspecialchars($stu['grado_seccion']) ?></td>
                <td><?= htmlspecialchars($stu['situacion_matricula']) ?></td>
                <td>
                    <!-- Aquí podemos añadir botones futuros -->
                    <a href="#">Ver</a> | 
                    <a href="#">Editar</a> | 
                    <a href="#">Eliminar</a>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
</body>
</html>
